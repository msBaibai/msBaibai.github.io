<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>在线点餐</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="css/bootstrap.min.css" />
		<script type="text/javascript" src="js/jquery.js" ></script>
	</head>
	<body>
		<div>
			<style>
				.sectionShowQRcode{
					width:100%;
				}
				.sectionShowQRcode>ul>li>span{
					position: absolute;
					right: 12px;
					color: #8A8989;
					letter-spacing: 1px;
				}
				.sectionShowQRcode>.img{
					width: 232px;
					height: 232px;
					display: block;
					margin: 0px auto;
					box-shadow: 0px 0px 5px #333333;
					position: relative;
					border: 16px #FFFFFF solid;
					margin-bottom: 30px;
				}
				.sectionShowQRcode>.img>span{
					width: 50px;
					height: 50px;
					position: absolute;
					display: block;
					margin:auto;
					top: 0;
					left: 0;
					bottom: 0;
					right: 0;
					background-color: #FFFFFF;
					background-image: url(img/payLogo.jpg);
					background-repeat: no-repeat;
					background-size: 100% 100%;
					border-radius: 5px;
					box-shadow: inset 0px 0px 5px #333333;
				}
				.loadingText{
					width:100%;
					height: 100%;
					position: fixed;
					top: 0px;
					left: 0px;
					background-color: rgba(0,0,0,0.3);
					z-index: 500;
					display: none;
				}
				.loadingText:after{
					content: "支付成功,正在下单...";
					width: 250px;
					height: 80px;
					position: fixed;
					left: 50%;
					margin-left: -125px;
					top: 50%;
					margin-top: -40px;
					background-color: #FFFFFF;
					border-radius: 10px;
					text-align: center;
					line-height: 80px;
					font-size: 16px;
					font-weight: bold;
				}
			</style>
			<header class="header">
				<h4>支付</h4>
				<a class="toBack"><span class="glyphicon glyphicon-chevron-left"></span></a>
			</header>
			<section class="sectionShowQRcode">
				<label class="titleLabel">以下为订单信息：</label>
				<ul class="list">
					<li>订单编号：<span>加载中...</span></li>
					<li>支付金额：<span>加载中...</span></li>
				</ul>
				<label class="titleLabel">请扫码以完成支付：</label>
				<div class="img">
					<span></span>
				</div>
			</section>
			<div class="loadingText"></div>
			<script>
				$.init=function(){
					loadJsM(["qrcode","jquery.qrcode"],function(){
						if($.wxAndAli=="WX"){
							$(".header>h4").html("微信支付");
						}else if($.wxAndAli=="ALI"){
							$(".header>h4").html("支付宝支付");
						}
						$(".sectionShowQRcode>ul>li:eq(0)>span").html($.data_OLBusiness);
						$(".sectionShowQRcode>ul>li:eq(1)>span").html("&yen;"+$.data_ftRecipe_Fee);
						$(".sectionShowQRcode>.img").qrcode({width:200,height:200,correctLevel:QRErrorCorrectLevel.H,text:$.data_codeUrl});
						var data={
						    "paraOutTradeNo": $.data_outTradeNo
						};
						
						var date=new Date().getTime();
						if(!!timer)
							clearInterval(timer);
						var timer=window.setInterval(function(){
							sendQueryResult("query",$.data_ktvId,$.wxAndAli,"SWEEPCODE",data,date,"",function(str){
								str=$.parseJSON(str);
								var result=str.trade_state||str.trade_status;
								if(!result)
									return;
								result=result.toUpperCase();
								console.log(result);
								if(result=="SUCCESS"||result=="TRADE_SUCCESS"){
									clearInterval(timer);
									var hrefArr=$.getHrefArr();
									if(hrefArr[hrefArr.length-2]=="openRoom.html"){
										sendOpenRoom(function(str){
											$.initOpenPage();
											$.clearHrefArrToMain();
											$.openRoomInfo=null;
											$.createConfirmBoxOK({"title":"系统提示","content":$(str).html(),"click":function(){
												window.location.href="#main.html";
											},"toBackEvent":function(){
												window.location.href="#main.html";
											}});
										});
									}else if(hrefArr[hrefArr.length-2]=="checkoutMoney.html"){
										sendPayClose(function(str){
											$.initOpenPage();
											$.clearHrefArrToMain();
											$.createConfirmBoxOK({"title":"系统提示","content":$(str).html(),"click":function(){
												window.location.href="#main.html";
											},"toBackEvent":function(){
												window.location.href="#main.html";
											}});
										});
									}else if(hrefArr[hrefArr.length-2]=="payment.html"){
										$(".loadingText").css("display","block");
										sendInsertStaffsPerformance(getSendInsertStaffsPerformanceData(),function(str){
	
										});
										sendPlaceAnOrder($.dataConfirmCheckedRoomId,$.data_currentUserId,100,100,$.payType,$.data_OLBusiness,$.createFoodListString(),function(str){
											$.initOpenPage();
											$(".loadingText").css("display","none");
											$.clearHrefArrToMain();
											$.createConfirmBoxOK({"title":"系统提示","content":$(str).html(),"click":function(){
												$.clearMenuData();
												window.location.href="#main.html";
											},"toBackEvent":function(){
												window.location.href="#main.html";
											}});
										});
									}
								}else if(result=="CLOSED"||result=="REVOKED"||result=="NOPAY"||result=="TRADE_CLOSED"){
									clearInterval(timer);
									//$.toBackFn=null;
									$.createConfirmBoxOK({"title":"系统提示","content":"支付终止或超时!","click":function(){
										$.initOpenPage();
										$.toBack();
									}});
								}
							});
							if(window.location.hash!="#showQRcode.html")
						    	clearInterval(timer);
						},3000);
						
						function sendQueryResult(op,ktvid,paytype,action,data,time,sign,parseDataFn){
							var queryName="";
							if(paytype=="WX")
								queryName="WxQuery";
							if(paytype=="ALI")
								queryName="AliQuery";
							$.ajax({
								type:"get",
								url:"json/WxQuery.json",
								//url:"https://pay.ktvsky.com/wx?op="+op+"&ktvid="+79396+"&paytype="+paytype+"&action="+action+"&time="+time+"&sign="+sign,
								dataType:"text",
								data:"data="+JSON.stringify(data),
								success:function(str){
									parseDataFn(str);
								},
								error:function(){
									//$.alt("操作失败!");
								}
							});
						}
						function sendPlaceAnOrder(roomId,staffId,zk1,zk2,payType,tradeD,foodListString,parseDataFn){
							$.ajax({
								type:"get",
								url:$.getRootPathAndPort()+"/erp/request",
								data:"url="+encodeURIComponent("OrderRecipesMobileERP/"+roomId+","+staffId+","+zk1+","+zk2+","+payType+","+tradeD)+"&method=post&postData="+encodeURIComponent(foodListString),
								//url:"http://10.0.3.28:8887/HttpCalculatorService/HttpCalculatorService/OrderRecipesMobileERP/"+roomId+","+staffId+","+zk1+","+zk2+","+payType+","+tradeD,
								dataType:"text",
								//data:foodListString,
								success:function(str){
									parseDataFn(str);
								},
								error:function(){
									$.alt("操作失败!");
								}
							});
						}
						
						function getSendInsertStaffsPerformanceData(){
							var staffsPerformance={};
							staffsPerformance.staffsPerformance_StaffsID=$.data_currentUserId;
							staffsPerformance.staffsPerformance_StaffsName=$.data_currentUserName;
							staffsPerformance.staffsPerformance_OutTradeNo=$.data_outTradeNo;
							staffsPerformance.staffsPerformance_Performance=$.data_ftRecipe_Fee;
							var date=new Date();
							var time=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+" "+date.getHours()+":"+date.getMinutes()+":"+date.getSeconds();
							staffsPerformance.staffsPerformance_Time=time;
							staffsPerformance.staffsPerformance_PayType=$.payType;
							return staffsPerformance;
						}
						function createDataString(name,obj){
							var str="";
							for(var i in obj){
								if(obj.hasOwnProperty(i)){
									str+=name+"."+i+"="+obj[i]+"&";
								}
							}
							str=str.substring(0,str.length-1);
							return str;
						}
						function sendInsertStaffsPerformance(staffsPerformance,parseDataFn){
							$.ajax({
								type:"post",
								//url:$.getRootPathAndPort()+"/erp/staffsPerformance!insert?staffsPerformance.staffsPerformance_StaffsID="+staffsPerformance.staffsPerformance_StaffsID+"&staffsPerformance.staffsPerformance_StaffsName="+staffsPerformance.staffsPerformance_StaffsName+"&staffsPerformance.staffsPerformance_OutTradeNo="+staffsPerformance.staffsPerformance_OutTradeNo+"&staffsPerformance.staffsPerformance_Performance="+staffsPerformance.staffsPerformance_Performance+"&staffsPerformance.staffsPerformance_Time="+staffsPerformance.staffsPerformance_Time+"&staffsPerformance.staffsPerformance_PayType="+staffsPerformance.staffsPerformance_PayType,
								url:$.getRootPathAndPort()+"/erp/staffsPerformance!insert",
								dataType:"text",
								data:createDataString("staffsPerformance",staffsPerformance),
								success:function(str){
									parseDataFn(str);
								},
								error:function(){
									$.alt("操作失败!");
								}
							});
						}
						function sendPayClose(parseDataFn){
							$.ajax({
								type:"get",
								url:$.getRootPathAndPort()+"/erp/request",
								data:"method=get&url="+encodeURIComponent("Payclose/"+$.dataConfirmCheckedRoomId+","+$.payType+","+$.data_OLBusiness+","+$.data_currentUserId),
								//url:"http://10.0.3.72:8887/HttpCalculatorService/HttpCalculatorService/Payclose/"+$.dataConfirmCheckedRoomId+","+payType+","+olID+","+$.data_currentUserId,
								dataType:"text",
								success:function(str){
									if(!!parseDataFn)
										parseDataFn(str);
								},
								error:function(){
									$.alt("操作失败!");
								}
							});
						}
						function sendOpenRoom(parseDataFn){
							if(!$.openRoomInfo)
								return;
							if(!$.openRoomInfo.bolIsTimeNum)
								$.openRoomInfo.time=0;
							if(!$.openRoomInfo.custmerName)
								$.openRoomInfo.custmerName=" ";
							if(!!$.openRoomInfo.bookingSN)
								$.openRoomInfo.bookingSN=$.trim($.openRoomInfo.bookingSN);
							if(!$.openRoomInfo.bookingID){
								$.openRoomInfo.custmerName=" ";
								$.openRoomInfo.personInsteadID="0";
								$.openRoomInfo.bookingID="0";
								$.openRoomInfo.bookingSN=" ";
							}
							$.ajax({
								type:"get",
								url:$.getRootPathAndPort()+"/erp/request",
								data:"method=get&url="+encodeURIComponent("NewOpenRoomPay/"+$.dataConfirmCheckedRoomId+","+$.openRoomInfo.custmerName+","+$.openRoomInfo.peopleNum+","+$.openRoomInfo.personInsteadID+","+$.data_currentUserId+","+$.openRoomInfo.drinkChargeType+","+$.openRoomInfo.roomChargeType+","+$.openRoomInfo.bookingID+","+$.openRoomInfo.bookingSN+","+$.openRoomInfo.time+","+$.payType+","+$.data_OLBusiness),
								//url:"http://10.0.3.72:8887/HttpCalculatorService/HttpCalculatorService/NewOpenRoomPay/"+$.dataConfirmCheckedRoomId+","+$.openRoomInfo.custmerName+","+$.openRoomInfo.peopleNum+","+$.openRoomInfo.personInsteadID+","+$.data_currentUserId+","+$.openRoomInfo.drinkChargeType+","+$.openRoomInfo.roomChargeType+","+$.openRoomInfo.bookingID+","+$.openRoomInfo.bookingSN+","+$.openRoomInfo.time+","+$.payType+","+$.data_OLBusiness,
								dataType:"text",
								success:function(str){
									if(!!parseDataFn)
										parseDataFn(str);
								},
								error:function(){
									$.alt("操作失败!");
								}
							});
						}
						
						function toBK(){
							window.setTimeout(function(){
								var hash=window.location.hash;
								$(window).off("hashchange").on("hashchange",function(){
									window.location.hash=hash;
									window.setTimeout(function(){
										$.createConfirmBox({"title":"系统提示","content":"支付未完成是否终止?","click":function(){
											clearInterval(timer);
											window.setTimeout(function(){
												$.toBack();
											},100);
										},"cancel":function(){
											toBK();
										}});
									},100);
								});
							},100);
						}
						toBK();
					});
				}
			</script>
		</div>
		
	</body>
</html>
